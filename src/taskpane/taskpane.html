<!doctype html>
<html lang="en" data-framework="typescript">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Synergia Contact Extractor</title>

  <!-- ── Content-Security-Policy ────────────────────────────────────────────── -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' https://appsforoffice.microsoft.com https://login.microsoftonline.com https://graph.microsoft.com https://cdn.ngrok.com https://assets.ngrok.com;
          script-src  'self' https://appsforoffice.microsoft.com 'unsafe-inline' 'unsafe-eval';
          font-src    'self' https://res.cdn.office.net https://static2.sharepointonline.com https://fonts.gstatic.com https://assets.ngrok.com https://cdn.ngrok.com;
          connect-src 'self' https://graph.microsoft.com https://login.microsoftonline.com;
          style-src   'self' 'unsafe-inline';
          img-src     'self' data:;
          object-src  'none';
          frame-ancestors 'self';
        " />

  <!-- Office JavaScript API -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
          type="text/javascript"></script>

  <!-- Override ngrok-banner font-face to load from self -->
  <style>
    /* EuclidSquare */
    @font-face {
      font-family: 'EuclidSquare';
      src: url('/assets/ngrok-banner/EuclidSquare-Regular-WebS.woff') format('woff');
      font-weight: 400; font-style: normal;
    }
    @font-face {
      font-family: 'EuclidSquare';
      src: url('/assets/ngrok-banner/EuclidSquare-RegularItalic-WebS.woff') format('woff');
      font-weight: 400; font-style: italic;
    }
    @font-face {
      font-family: 'EuclidSquare';
      src: url('/assets/ngrok-banner/EuclidSquare-Medium-WebS.woff') format('woff');
      font-weight: 500; font-style: normal;
    }
    @font-face {
      font-family: 'EuclidSquare';
      src: url('/assets/ngrok-banner/EuclidSquare-Semibold-WebS.woff') format('woff');
      font-weight: 600; font-style: normal;
    }
    @font-face {
      font-family: 'EuclidSquare';
      src: url('/assets/ngrok-banner/EuclidSquare-MediumItalic-WebS.woff') format('woff');
      font-weight: 500; font-style: italic;
    }
    /* IBM Plex Mono */
    @font-face {
      font-family: 'IBMPlexMono';
      src: url('/assets/ngrok-banner/IBMPlexMono-Text.woff') format('woff');
      font-weight: 400; font-style: normal;
    }
    @font-face {
      font-family: 'IBMPlexMono';
      src: url('/assets/ngrok-banner/IBMPlexMono-TextItalic.woff') format('woff');
      font-weight: 400; font-style: italic;
    }
    @font-face {
      font-family: 'IBMPlexMono';
      src: url('/assets/ngrok-banner/IBMPlexMono-SemiBold.woff') format('woff');
      font-weight: 600; font-style: normal;
    }
    @font-face {
      font-family: 'IBMPlexMono';
      src: url('/assets/ngrok-banner/IBMPlexMono-SemiBoldItalic.woff') format('woff');
      font-weight: 600; font-style: italic;
    }
  </style>

  <script>
    /* --------------------------- Task-pane logic ---------------------------- */
    Office.onReady(() => {
      Office.actions.associate("extractContact", extractContact);
    });

    async function extractContact(event) {
      const item        = Office.context.mailbox.item;
      const senderName  = item.from?.displayName  || "";
      const senderEmail = item.from?.emailAddress || "";

      /* 1 · Organisatie = stukje tussen '@' en eerste '.', Title-case */
      const rawSeed      = senderEmail.split('@')[1]?.split('.')[0] || "";
      const organization = rawSeed
        ? rawSeed.charAt(0).toUpperCase() + rawSeed.slice(1).toLowerCase()
        : "";

      /* 2 · Body ophalen en parsen */
      item.body.getAsync(Office.CoercionType.Text, async result => {
        if (result.status !== Office.AsyncResultStatus.Succeeded) {
          console.error(result.error);
          event.completed();
          return;
        }

        const sig  = extractSignatureBlock(result.value, senderName);
        const info = parseSignature(sig, senderName, senderEmail, organization);

        /* 3 · Info-banner tonen */
        item.notificationMessages.addAsync(
          "contactInfo",
          {
            type:       Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,
            message:    `Naam: ${info.name || '-'} | E-mail: ${info.email || '-'} | Tel: ${info.phone || '-'} | Organisatie: ${info.organization || '-'} | Postcode: ${info.postcode || '-'}`,
            icon:       "Icon.80x80",
            persistent: false
          },
          async () => {
            /* 4 · Contact via Graph opslaan */
            try {
              const accessToken = await OfficeRuntime.auth.getAccessToken({ allowSignInPrompt: true });

              const contactPayload = {
                givenName:      info.name,
                emailAddresses: [{ address: info.email, name: info.name }],
                businessPhones: [info.phone],
                companyName:    info.organization,
                homeAddress:   { postalCode: info.postcode }
              };

              const graphRes = await fetch(
                "https://graph.microsoft.com/v1.0/me/contacts",
                {
                  method:  "POST",
                  headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type":  "application/json"
                  },
                  body: JSON.stringify(contactPayload)
                }
              );
              if (!graphRes.ok) {
                const text = await graphRes.text();
                throw new Error(`${graphRes.status} ${text}`);
              }

              /* 5 · Succes-banner */
              item.notificationMessages.addAsync(
                "saveSuccess",
                {
                  type:       Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,
                  message:    "✅ Contact opgeslagen!",
                  icon:       "Icon.80x80",
                  persistent: false
                }
              );
            } catch (err) {
              console.error(err);
              /* 6 · Fout-banner */
              item.notificationMessages.addAsync(
                "saveError",
                {
                  type:       Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,
                  message:    "❌ Opslaan mislukt: " + err.message,
                  persistent: false
                }
              );
            } finally {
              event.completed();
            }
          }
        );
      });
    }

    /* ----------------------- Hulpfuncties ----------------------- */

    function extractSignatureBlock(body, senderName) {
      if (senderName) {
        const idx = body.indexOf(senderName);
        if (idx >= 0) return body.substring(idx).trim();
      }
      const parts = body.split(/\r?\n\s*\r?\n/);
      return (parts.length > 1 ? parts.pop() : body).trim();
    }

    function parseSignature(sig, senderName, senderEmail, organization) {
      const lines = sig.split(/\r?\n/).map(l => l.trim()).filter(l => l);

      /* Naam */
      let name = "";
      if (senderName && sig.toLowerCase().includes(senderName.toLowerCase())) {
        name = senderName;
      } else {
        for (const line of lines) {
          if (line.includes(senderEmail))                continue;
          if (/\+?\d[\d\-\u2013()\s]{5,}\d/.test(line))  continue;
          if (/https?:\/\//i.test(line))                continue;
          if (/www\./i.test(line))                      continue;
          if (/^[\+\d]/.test(line))                     continue;
          name = line;
          break;
        }
      }

      /* E-mail */
      const email = senderEmail;

      /* Telefoon (langste match) */
      const phoneRegex = /(\+?\d[\d\-\u2013()\s]{5,}\d)/g;
      const matches    = [];
      let m;
      while ((m = phoneRegex.exec(sig))) matches.push(m[1]);
      const phone = matches.length
        ? matches.reduce((a, b) => (a.length >= b.length ? a : b))
        : "";

      /* Postcode (1234 AB) */
      const postcodeRegex = /\b\d{4}\s?[A-Za-z]{2}\b/;
      let postcode = "";
      for (const line of lines) {
        const mp = line.match(postcodeRegex);
        if (mp) { postcode = mp[0]; break; }
      }

      return { name, email, phone, organization, postcode };
    }
  </script>
</head>

<body style="width:100%;height:100%;margin:0;padding:0;">
  <div id="container"></div>

  <!-- Fallback voor IE/EdgeHTML -->
  <div id="tridentmessage" style="display:none;padding:10px;">
    Deze add-in werkt niet in Edge Legacy of IE. Upgrade naar Office 2021 of Microsoft 365.
  </div>
  <script>
    if (navigator.userAgent.includes("Trident") ||
        navigator.userAgent.includes("Edge")) {
      document.getElementById("tridentmessage").style.display = "block";
      document.getElementById("container").style.display       = "none";
    }
  </script>
</body>
</html>

